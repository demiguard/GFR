{% extends 'main_page/base.html' %}

{% load static %}
{% load bootstrap4 %}

{% block head %}
  <link rel="stylesheet" type="text/css" href="{% static 'main_page/css/fill_study.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'main_page/css/util/alerter.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'main_page/css/util/csv-row.css' %}">
{% endblock head %}


{% block content %}
  <strong>Accession nr.:</strong><p>{{ rigsnr }}</p>

  <form method="POST" id="fill-study-form">
    {% csrf_token %}
    
    <!-- Add patient info -->
    <div class="form-row">
      <div class = "form-group col-md-3">
        {% bootstrap_form study_patient_form %}
      </div>
      <div class = "form-group col-md-3">
        {% bootstrap_form study_patient_form_2 %}
      </div>
      <div class="form-group col-md-3">
        {% bootstrap_form study_examination_form %}
      </div>  
      <div class = "form-group col-md-3">
        {% bootstrap_form study_dosis_form %}
        <small><a id="reset_thin_fac" href="#">Hent fortyndingsfaktor</a></small>
        {% bootstrap_form study_type_form %}
      </div>
    </div>
    
    <hr>

    <!-- Second Half -->
    <div class="row">
      <!-- Left side-->
      <div class="col-md-6">
        <!-- Display test info -->
        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="standard-field">Standardt√¶lletal</label>
            <input type="number" step="0.001" class="form-control" id="standard-field" name="std_cnt_text_box" value="{{ standard_count }}">
          </div>
        </div>
        {% buttons %}
          <input type="button" value="Tilf√∏j standard" id="add-standard">
        {% endbuttons %}
        
        <h5>Pr√∏ve data</h5>
        <div id="test-data-container">
          <!-- Place where JS inserts new test data -->

          <!-- Insert previous tests -->
          {% for psd, pst, psc in previous_samples %}
            <div class="form-row">
              <div class="form-group col-md-3 readonly-field">
                <input type="text" class="form-control" name="study_date" value="{{ psd }}" readonly>
              </div>
              <div class="form-group col-md-3 readonly-field">
                <input type="text" class="form-control" name="study_time" value="{{ pst }}" readonly>
              </div>
              <div class="form-group col-md-3 readonly-field">
                <input type="text" class="form-control" name="test_value" value="{{ psc }}" readonly>
              </div>
              <div class="form-group col-md-1">
                <input type="button" value="X" class="row-remove-btn btn btn-danger" id="remove{{ forloop.counter0 }}">
              </div>
              <div class="form-group col-md-1">
                <input type="button" value="üîí" class="row-lock-btn btn btn-light" id="lock{{ forloop.counter0 }}">
              </div>
            </div>
          {% endfor %}
        </div>
        <!-- Add test info -->     
        <div id="add-test-container">
          <strong>Tilf√∏j pr√∏ve:</strong>
          <div class="form-row" id="form-top">
            <div class="form-group col-md-4">
              {{ test_form.study_date.label }}
              {{ test_form.study_date }}
            </div>
            <div class="form-group col-md-4">
              {{ test_form.study_time.label }}
              {{ test_form.study_time }}
            </div>
          </div>
          {% buttons %}
            <input type="button" value="Tilf√∏j pr√∏ve" id="add-test">
            <input type="button" value="Tilf√∏j tom pr√∏ve" id="add-empty-value">
            <input type="button" value="Nulstil valgte pr√∏ver" id="reset-selected">
          {% endbuttons %}
        </div>
        {% buttons%}
          <input type="submit" name="calculate" value="Beregn" id="calculate">
          <input type="submit" name="save" value="Gem" id="save">
          <input type="button" value="Afbryd" id="cancel">
        {% endbuttons %}

        <!-- Container for error/alert messages -->
        <div id="error-message-container">
  
        </div>
      <!-- Left Closing -->
      </div>

      <!-- Right side -->
      <div class="col-md-6" id="right_side">
        {% if csv_data_len != 0 %}
          <p><strong>V√¶lg pr√∏ve fra fil:</strong></p>
            <div class="csvAccordion" id="accordionContainer">
              {% for name, data, id in csv_data %}
                <div class="card">
                  <div class="card-header" id="heading-{{ id }}">
                    <h2 class="mb-0">
                      <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse-{{ id }}" aria-expanded="true" aria-controls="collapse-{{ id }}">
                        {{ name }}
                      </button>
                    </h2>
                  </div> <!-- card header closing-->
        
                  <div id="collapse-{{ id }}" class="collapse" aria-labelledby="heading-{{ id }}" data-parent="#accordionContainer">
                    <div class="card-body">
                      <table class="table table-bordered table-hover">
                        <thead>
                          <tr>
                            <th>Rack</th>
                            <th>Position</th>
                            <th>Tc-99 CPM</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for data_row in data %}
                            <tr class="csv_row" id="{{ id }}-{{ forloop.counter }}">
                              <td>{{ data_row.0 }}</td>
                              <td>{{ data_row.1 }}</td>
                              <td>{{ data_row.2 }}</td>
                            </tr>  
                          {% endfor %}
                        </tbody>
                      </table>
                    </div> <!-- card-body Closing -->
                  </div> <!--collapse-ID closing -->
                </div> <!-- card Closing -->
                
                <br>
              {% endfor %}
            </div> <!-- AccordingContainer Closing -->
            {% else %}
            <p id="server-error-msg">{{ error_message }}</p>
          <!-- </div> -->
        {% endif %}

        <div id="dynamic_generate_history">
          <input type="button" value="Tilbage til dagens m√•linger" onclick="remove_backup_measurement()">
          
          <br><br>
          
          <div id="history_container">

          </div> <!--history_container Closing-->
        </div> <!-- dynamic_generate_history Closing-->
        
        {% bootstrap_form get_backup_date_form %}
        <input type="button" value="Hent m√•linger" onclick="get_backup_measurements()">
      </div> <!-- Right closing-->
    </div>
  </form>

{% endblock %}

{% block javascript %}
<script src="{% static 'main_page/js/util/csrf.js' %}"></script>
  <script src="{% static 'main_page/js/util/helpers.js' %}"></script>
  <script src="{% static 'main_page/js/util/alerter.js' %}"></script>
  <script src="{% static 'main_page/js/util/csv_handler.js' %}"></script>
  <script src="{% static 'main_page/js/fill_study.js' %}"></script>
{% endblock %}