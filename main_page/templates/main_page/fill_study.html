{% extends 'main_page/base.html' %}

{% load static %}
{% load bootstrap4 %}

{% block head %}
  <link rel="stylesheet" type="text/css" href="{% static 'main_page/css/fill_study.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'main_page/css/util/alerter.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'main_page/css/util/csv-row.css' %}">
{% endblock head %}


{% block content %}
  <strong>Accession nr.:</strong><p>{{ rigsnr }}</p>

  <form method="POST" id="fill-study-form">
    {% csrf_token %}
    
    <!-- Add patient info -->
    <div class="form-row">
      <div class = "form-group col-md-3">
        {% bootstrap_form study_patient_form %}
      </div>
      <div class = "form-group col-md-3">
        {% bootstrap_form study_patient_form_2 %}
      </div>
      <div class="form-group col-md-3">
        {% bootstrap_form study_examination_form %}
      </div>  
      <div class = "form-group col-md-3">
        {% bootstrap_form study_dosis_form %}
        <!-- {{ study_dosis_form.thin_fac.label }} -->
        <small><a id="reset_thin_fac" href="#">Hent fortyndingsfaktor</a></small>
        {% bootstrap_form study_type_form %}
      </div>
    </div>
    
    <hr>

    <!-- Second Half -->
    <div class="row">
      <!-- Left side-->
      <div class="col-md-6">
        <!-- Display test info -->
        <strong>Stardardt√¶lletal</strong>
        <div class="form-row">
          <div class="form-group col-md-6">
            <input type="number" step="0.001" class="form-control" id="standard-field" name="std_cnt_text_box" value="{{ standard_count }}">
          </div>
        </div>
        {% buttons %}
          <input type="button" value="Tilf√∏j standard" id="add-standard">
        {% endbuttons %}
        
        <h5>Pr√∏ve data</h5>
        <div id="test-data-container">
          <!-- Place where JS inserts new test data -->

          <!-- Insert previous tests -->
          {% for psd, pst, psc in previous_samples %}
            <div class="form-row">
              <div class="form-group col-md-3 readonly-field">
                <input type="text" class="form-control" name="study_date" value="{{ psd }}" readonly>
              </div>
              <div class="form-group col-md-3 readonly-field">
                <input type="text" class="form-control" name="study_time" value="{{ pst }}" readonly>
              </div>
              <div class="form-group col-md-3 readonly-field">
                <input type="text" class="form-control" name="test_value" value="{{ psc }}" readonly>
              </div>
              <div class="form-group col-md-1">
                <input type="button" value="X" class="row-remove-btn btn btn-danger" id="remove{{ forloop.counter0 }}">
              </div>
              <div class="form-group col-md-1">
                <input type="button" value="üîí" class="row-lock-btn btn btn-light" id="lock{{ forloop.counter0 }}">
              </div>
            </div>
          {% endfor %}
        </div>
        <!-- Add test info -->     
        <div id="add-test-container">
          <strong>Tilf√∏j pr√∏ve:</strong>
          <div class="form-row" id="form-top">
            <div class="form-group col-md-4">
              {{ test_context.test_form.study_date.label }}
              {{ test_context.test_form.study_date }}
            </div>
            <div class="form-group col-md-4">
              {{ test_context.test_form.study_time.label }}
              {{ test_context.test_form.study_time }}
            </div>
          </div>
          {% buttons %}
            <input type="button" value="Tilf√∏j pr√∏ve" id="add-test">
            <input type="button" value="Nulstil valgte pr√∏ver" id="reset-selected">
          {% endbuttons %}
        </div>
        {% buttons%}
          <input type="submit" name="calculate" value="Beregn" id="calculate">
          <input type="submit" name="save" value="Gem" id="save">
          <input type="button" value="Afbryd" id="cancel">
        {% endbuttons %}

        <!-- Container for error/alert messages -->
        <div id="error-message-container">
  
        </div>
      <!-- Left Closing -->
      </div>

      <!-- Right side -->
      {% if csv_data_len != 0 %}
      <div class="col-md-6" id="right_side">
        <p><strong>V√¶lg pr√∏ve fra fil</strong></p>
        <div class="csvAccordion" id="accordionContainer">
          {% for name, data, id in csv_data %}
            <div class="card">
              <div class="card-header" id="heading-{{ id }}">
                <h2 class="mb-0">
                  <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse-{{ id }}" aria-expanded="true" aria-controls="collapse-{{ id }}">
                    {{ name }}
                  </button>
                </h2>
              </div>
    
              <div id="collapse-{{ id }}" class="collapse" aria-labelledby="heading-{{ id }}" data-parent="#accordionContainer">
                <div class="card-body">
                  <table class="table table-bordered table-hover">
                    <thead>
                      <tr>
                        <th>Rack</th>
                        <th>Position</th>
                        <th>Tc-99 CPM</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for data_row in data %}
                        <tr class="csv_row" id="{{ id }}-{{ forloop.counter }}">
                          <td>{{ data_row.0 }}</td>
                          <td>{{ data_row.1 }}</td>
                          <td>{{ data_row.2 }}</td>
                        </tr>  
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <br>
          {% endfor %}
        </div>
        {% else %}
          <p>{{ error_message }}</p>
        {% endif %}
      <!-- Right closing-->
      </div>
    </div>
  </form>

{% endblock %}

{% block javascript %}
  <script src="{% static 'main_page/js/util/helpers.js' %}"></script>
  <script src="{% static 'main_page/js/util/alerter.js' %}"></script>
  <script src="{% static 'main_page/js/util/csv_handler.js' %}"></script>
  <script src="{% static 'main_page/js/fill_study.js' %}"></script>
{% endblock %}